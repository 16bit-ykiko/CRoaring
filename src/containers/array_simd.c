#include <x86intrin.h>

#include "array.h"

// used by intersect_vector16
static const uint8_t shuffle_mask16[] __attribute__((aligned(0x1000))) = {
    -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  -1,
    -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 2,  3,  -1, -1, -1, -1,
    -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  2,  3,  -1, -1, -1, -1, -1,
    -1, -1, -1, -1, -1, -1, -1, 4,  5,  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
    -1, -1, -1, -1, 0,  1,  4,  5,  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
    -1, 2,  3,  4,  5,  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,
    2,  3,  4,  5,  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 6,  7,  -1, -1, -1,
    -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  6,  7,  -1, -1, -1, -1,
    -1, -1, -1, -1, -1, -1, -1, -1, 2,  3,  6,  7,  -1, -1, -1, -1, -1, -1, -1,
    -1, -1, -1, -1, -1, 0,  1,  2,  3,  6,  7,  -1, -1, -1, -1, -1, -1, -1, -1,
    -1, -1, 4,  5,  6,  7,  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0,
    1,  4,  5,  6,  7,  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 2,  3,  4,  5,
    6,  7,  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  2,  3,  4,  5,  6,
    7,  -1, -1, -1, -1, -1, -1, -1, -1, 8,  9,  -1, -1, -1, -1, -1, -1, -1, -1,
    -1, -1, -1, -1, -1, -1, 0,  1,  8,  9,  -1, -1, -1, -1, -1, -1, -1, -1, -1,
    -1, -1, -1, 2,  3,  8,  9,  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
    0,  1,  2,  3,  8,  9,  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 4,  5,  8,
    9,  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  4,  5,  8,  9,
    -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 2,  3,  4,  5,  8,  9,  -1, -1, -1,
    -1, -1, -1, -1, -1, -1, -1, 0,  1,  2,  3,  4,  5,  8,  9,  -1, -1, -1, -1,
    -1, -1, -1, -1, 6,  7,  8,  9,  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
    -1, 0,  1,  6,  7,  8,  9,  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 2,  3,
    6,  7,  8,  9,  -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  2,  3,  6,
    7,  8,  9,  -1, -1, -1, -1, -1, -1, -1, -1, 4,  5,  6,  7,  8,  9,  -1, -1,
    -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  4,  5,  6,  7,  8,  9,  -1, -1, -1,
    -1, -1, -1, -1, -1, 2,  3,  4,  5,  6,  7,  8,  9,  -1, -1, -1, -1, -1, -1,
    -1, -1, 0,  1,  2,  3,  4,  5,  6,  7,  8,  9,  -1, -1, -1, -1, -1, -1, 10,
    11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  10, 11,
    -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 2,  3,  10, 11, -1, -1, -1,
    -1, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  2,  3,  10, 11, -1, -1, -1, -1,
    -1, -1, -1, -1, -1, -1, 4,  5,  10, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1,
    -1, -1, -1, 0,  1,  4,  5,  10, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
    2,  3,  4,  5,  10, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  2,
    3,  4,  5,  10, 11, -1, -1, -1, -1, -1, -1, -1, -1, 6,  7,  10, 11, -1, -1,
    -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  6,  7,  10, 11, -1, -1, -1,
    -1, -1, -1, -1, -1, -1, -1, 2,  3,  6,  7,  10, 11, -1, -1, -1, -1, -1, -1,
    -1, -1, -1, -1, 0,  1,  2,  3,  6,  7,  10, 11, -1, -1, -1, -1, -1, -1, -1,
    -1, 4,  5,  6,  7,  10, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,
    4,  5,  6,  7,  10, 11, -1, -1, -1, -1, -1, -1, -1, -1, 2,  3,  4,  5,  6,
    7,  10, 11, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  2,  3,  4,  5,  6,  7,
    10, 11, -1, -1, -1, -1, -1, -1, 8,  9,  10, 11, -1, -1, -1, -1, -1, -1, -1,
    -1, -1, -1, -1, -1, 0,  1,  8,  9,  10, 11, -1, -1, -1, -1, -1, -1, -1, -1,
    -1, -1, 2,  3,  8,  9,  10, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0,
    1,  2,  3,  8,  9,  10, 11, -1, -1, -1, -1, -1, -1, -1, -1, 4,  5,  8,  9,
    10, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  4,  5,  8,  9,  10,
    11, -1, -1, -1, -1, -1, -1, -1, -1, 2,  3,  4,  5,  8,  9,  10, 11, -1, -1,
    -1, -1, -1, -1, -1, -1, 0,  1,  2,  3,  4,  5,  8,  9,  10, 11, -1, -1, -1,
    -1, -1, -1, 6,  7,  8,  9,  10, 11, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
    0,  1,  6,  7,  8,  9,  10, 11, -1, -1, -1, -1, -1, -1, -1, -1, 2,  3,  6,
    7,  8,  9,  10, 11, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  2,  3,  6,  7,
    8,  9,  10, 11, -1, -1, -1, -1, -1, -1, 4,  5,  6,  7,  8,  9,  10, 11, -1,
    -1, -1, -1, -1, -1, -1, -1, 0,  1,  4,  5,  6,  7,  8,  9,  10, 11, -1, -1,
    -1, -1, -1, -1, 2,  3,  4,  5,  6,  7,  8,  9,  10, 11, -1, -1, -1, -1, -1,
    -1, 0,  1,  2,  3,  4,  5,  6,  7,  8,  9,  10, 11, -1, -1, -1, -1, 12, 13,
    -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  12, 13, -1,
    -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 2,  3,  12, 13, -1, -1, -1, -1,
    -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  2,  3,  12, 13, -1, -1, -1, -1, -1,
    -1, -1, -1, -1, -1, 4,  5,  12, 13, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
    -1, -1, 0,  1,  4,  5,  12, 13, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 2,
    3,  4,  5,  12, 13, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  2,  3,
    4,  5,  12, 13, -1, -1, -1, -1, -1, -1, -1, -1, 6,  7,  12, 13, -1, -1, -1,
    -1, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  6,  7,  12, 13, -1, -1, -1, -1,
    -1, -1, -1, -1, -1, -1, 2,  3,  6,  7,  12, 13, -1, -1, -1, -1, -1, -1, -1,
    -1, -1, -1, 0,  1,  2,  3,  6,  7,  12, 13, -1, -1, -1, -1, -1, -1, -1, -1,
    4,  5,  6,  7,  12, 13, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  4,
    5,  6,  7,  12, 13, -1, -1, -1, -1, -1, -1, -1, -1, 2,  3,  4,  5,  6,  7,
    12, 13, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  2,  3,  4,  5,  6,  7,  12,
    13, -1, -1, -1, -1, -1, -1, 8,  9,  12, 13, -1, -1, -1, -1, -1, -1, -1, -1,
    -1, -1, -1, -1, 0,  1,  8,  9,  12, 13, -1, -1, -1, -1, -1, -1, -1, -1, -1,
    -1, 2,  3,  8,  9,  12, 13, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,
    2,  3,  8,  9,  12, 13, -1, -1, -1, -1, -1, -1, -1, -1, 4,  5,  8,  9,  12,
    13, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  4,  5,  8,  9,  12, 13,
    -1, -1, -1, -1, -1, -1, -1, -1, 2,  3,  4,  5,  8,  9,  12, 13, -1, -1, -1,
    -1, -1, -1, -1, -1, 0,  1,  2,  3,  4,  5,  8,  9,  12, 13, -1, -1, -1, -1,
    -1, -1, 6,  7,  8,  9,  12, 13, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0,
    1,  6,  7,  8,  9,  12, 13, -1, -1, -1, -1, -1, -1, -1, -1, 2,  3,  6,  7,
    8,  9,  12, 13, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  2,  3,  6,  7,  8,
    9,  12, 13, -1, -1, -1, -1, -1, -1, 4,  5,  6,  7,  8,  9,  12, 13, -1, -1,
    -1, -1, -1, -1, -1, -1, 0,  1,  4,  5,  6,  7,  8,  9,  12, 13, -1, -1, -1,
    -1, -1, -1, 2,  3,  4,  5,  6,  7,  8,  9,  12, 13, -1, -1, -1, -1, -1, -1,
    0,  1,  2,  3,  4,  5,  6,  7,  8,  9,  12, 13, -1, -1, -1, -1, 10, 11, 12,
    13, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  10, 11, 12, 13,
    -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 2,  3,  10, 11, 12, 13, -1, -1, -1,
    -1, -1, -1, -1, -1, -1, -1, 0,  1,  2,  3,  10, 11, 12, 13, -1, -1, -1, -1,
    -1, -1, -1, -1, 4,  5,  10, 11, 12, 13, -1, -1, -1, -1, -1, -1, -1, -1, -1,
    -1, 0,  1,  4,  5,  10, 11, 12, 13, -1, -1, -1, -1, -1, -1, -1, -1, 2,  3,
    4,  5,  10, 11, 12, 13, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  2,  3,  4,
    5,  10, 11, 12, 13, -1, -1, -1, -1, -1, -1, 6,  7,  10, 11, 12, 13, -1, -1,
    -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  6,  7,  10, 11, 12, 13, -1, -1, -1,
    -1, -1, -1, -1, -1, 2,  3,  6,  7,  10, 11, 12, 13, -1, -1, -1, -1, -1, -1,
    -1, -1, 0,  1,  2,  3,  6,  7,  10, 11, 12, 13, -1, -1, -1, -1, -1, -1, 4,
    5,  6,  7,  10, 11, 12, 13, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  4,  5,
    6,  7,  10, 11, 12, 13, -1, -1, -1, -1, -1, -1, 2,  3,  4,  5,  6,  7,  10,
    11, 12, 13, -1, -1, -1, -1, -1, -1, 0,  1,  2,  3,  4,  5,  6,  7,  10, 11,
    12, 13, -1, -1, -1, -1, 8,  9,  10, 11, 12, 13, -1, -1, -1, -1, -1, -1, -1,
    -1, -1, -1, 0,  1,  8,  9,  10, 11, 12, 13, -1, -1, -1, -1, -1, -1, -1, -1,
    2,  3,  8,  9,  10, 11, 12, 13, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  2,
    3,  8,  9,  10, 11, 12, 13, -1, -1, -1, -1, -1, -1, 4,  5,  8,  9,  10, 11,
    12, 13, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  4,  5,  8,  9,  10, 11, 12,
    13, -1, -1, -1, -1, -1, -1, 2,  3,  4,  5,  8,  9,  10, 11, 12, 13, -1, -1,
    -1, -1, -1, -1, 0,  1,  2,  3,  4,  5,  8,  9,  10, 11, 12, 13, -1, -1, -1,
    -1, 6,  7,  8,  9,  10, 11, 12, 13, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,
    6,  7,  8,  9,  10, 11, 12, 13, -1, -1, -1, -1, -1, -1, 2,  3,  6,  7,  8,
    9,  10, 11, 12, 13, -1, -1, -1, -1, -1, -1, 0,  1,  2,  3,  6,  7,  8,  9,
    10, 11, 12, 13, -1, -1, -1, -1, 4,  5,  6,  7,  8,  9,  10, 11, 12, 13, -1,
    -1, -1, -1, -1, -1, 0,  1,  4,  5,  6,  7,  8,  9,  10, 11, 12, 13, -1, -1,
    -1, -1, 2,  3,  4,  5,  6,  7,  8,  9,  10, 11, 12, 13, -1, -1, -1, -1, 0,
    1,  2,  3,  4,  5,  6,  7,  8,  9,  10, 11, 12, 13, -1, -1, 14, 15, -1, -1,
    -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  14, 15, -1, -1, -1,
    -1, -1, -1, -1, -1, -1, -1, -1, -1, 2,  3,  14, 15, -1, -1, -1, -1, -1, -1,
    -1, -1, -1, -1, -1, -1, 0,  1,  2,  3,  14, 15, -1, -1, -1, -1, -1, -1, -1,
    -1, -1, -1, 4,  5,  14, 15, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
    0,  1,  4,  5,  14, 15, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 2,  3,  4,
    5,  14, 15, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  2,  3,  4,  5,
    14, 15, -1, -1, -1, -1, -1, -1, -1, -1, 6,  7,  14, 15, -1, -1, -1, -1, -1,
    -1, -1, -1, -1, -1, -1, -1, 0,  1,  6,  7,  14, 15, -1, -1, -1, -1, -1, -1,
    -1, -1, -1, -1, 2,  3,  6,  7,  14, 15, -1, -1, -1, -1, -1, -1, -1, -1, -1,
    -1, 0,  1,  2,  3,  6,  7,  14, 15, -1, -1, -1, -1, -1, -1, -1, -1, 4,  5,
    6,  7,  14, 15, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  4,  5,  6,
    7,  14, 15, -1, -1, -1, -1, -1, -1, -1, -1, 2,  3,  4,  5,  6,  7,  14, 15,
    -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  2,  3,  4,  5,  6,  7,  14, 15, -1,
    -1, -1, -1, -1, -1, 8,  9,  14, 15, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
    -1, -1, 0,  1,  8,  9,  14, 15, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 2,
    3,  8,  9,  14, 15, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  2,  3,
    8,  9,  14, 15, -1, -1, -1, -1, -1, -1, -1, -1, 4,  5,  8,  9,  14, 15, -1,
    -1, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  4,  5,  8,  9,  14, 15, -1, -1,
    -1, -1, -1, -1, -1, -1, 2,  3,  4,  5,  8,  9,  14, 15, -1, -1, -1, -1, -1,
    -1, -1, -1, 0,  1,  2,  3,  4,  5,  8,  9,  14, 15, -1, -1, -1, -1, -1, -1,
    6,  7,  8,  9,  14, 15, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  6,
    7,  8,  9,  14, 15, -1, -1, -1, -1, -1, -1, -1, -1, 2,  3,  6,  7,  8,  9,
    14, 15, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  2,  3,  6,  7,  8,  9,  14,
    15, -1, -1, -1, -1, -1, -1, 4,  5,  6,  7,  8,  9,  14, 15, -1, -1, -1, -1,
    -1, -1, -1, -1, 0,  1,  4,  5,  6,  7,  8,  9,  14, 15, -1, -1, -1, -1, -1,
    -1, 2,  3,  4,  5,  6,  7,  8,  9,  14, 15, -1, -1, -1, -1, -1, -1, 0,  1,
    2,  3,  4,  5,  6,  7,  8,  9,  14, 15, -1, -1, -1, -1, 10, 11, 14, 15, -1,
    -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  10, 11, 14, 15, -1, -1,
    -1, -1, -1, -1, -1, -1, -1, -1, 2,  3,  10, 11, 14, 15, -1, -1, -1, -1, -1,
    -1, -1, -1, -1, -1, 0,  1,  2,  3,  10, 11, 14, 15, -1, -1, -1, -1, -1, -1,
    -1, -1, 4,  5,  10, 11, 14, 15, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0,
    1,  4,  5,  10, 11, 14, 15, -1, -1, -1, -1, -1, -1, -1, -1, 2,  3,  4,  5,
    10, 11, 14, 15, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  2,  3,  4,  5,  10,
    11, 14, 15, -1, -1, -1, -1, -1, -1, 6,  7,  10, 11, 14, 15, -1, -1, -1, -1,
    -1, -1, -1, -1, -1, -1, 0,  1,  6,  7,  10, 11, 14, 15, -1, -1, -1, -1, -1,
    -1, -1, -1, 2,  3,  6,  7,  10, 11, 14, 15, -1, -1, -1, -1, -1, -1, -1, -1,
    0,  1,  2,  3,  6,  7,  10, 11, 14, 15, -1, -1, -1, -1, -1, -1, 4,  5,  6,
    7,  10, 11, 14, 15, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  4,  5,  6,  7,
    10, 11, 14, 15, -1, -1, -1, -1, -1, -1, 2,  3,  4,  5,  6,  7,  10, 11, 14,
    15, -1, -1, -1, -1, -1, -1, 0,  1,  2,  3,  4,  5,  6,  7,  10, 11, 14, 15,
    -1, -1, -1, -1, 8,  9,  10, 11, 14, 15, -1, -1, -1, -1, -1, -1, -1, -1, -1,
    -1, 0,  1,  8,  9,  10, 11, 14, 15, -1, -1, -1, -1, -1, -1, -1, -1, 2,  3,
    8,  9,  10, 11, 14, 15, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  2,  3,  8,
    9,  10, 11, 14, 15, -1, -1, -1, -1, -1, -1, 4,  5,  8,  9,  10, 11, 14, 15,
    -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  4,  5,  8,  9,  10, 11, 14, 15, -1,
    -1, -1, -1, -1, -1, 2,  3,  4,  5,  8,  9,  10, 11, 14, 15, -1, -1, -1, -1,
    -1, -1, 0,  1,  2,  3,  4,  5,  8,  9,  10, 11, 14, 15, -1, -1, -1, -1, 6,
    7,  8,  9,  10, 11, 14, 15, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  6,  7,
    8,  9,  10, 11, 14, 15, -1, -1, -1, -1, -1, -1, 2,  3,  6,  7,  8,  9,  10,
    11, 14, 15, -1, -1, -1, -1, -1, -1, 0,  1,  2,  3,  6,  7,  8,  9,  10, 11,
    14, 15, -1, -1, -1, -1, 4,  5,  6,  7,  8,  9,  10, 11, 14, 15, -1, -1, -1,
    -1, -1, -1, 0,  1,  4,  5,  6,  7,  8,  9,  10, 11, 14, 15, -1, -1, -1, -1,
    2,  3,  4,  5,  6,  7,  8,  9,  10, 11, 14, 15, -1, -1, -1, -1, 0,  1,  2,
    3,  4,  5,  6,  7,  8,  9,  10, 11, 14, 15, -1, -1, 12, 13, 14, 15, -1, -1,
    -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  12, 13, 14, 15, -1, -1, -1,
    -1, -1, -1, -1, -1, -1, -1, 2,  3,  12, 13, 14, 15, -1, -1, -1, -1, -1, -1,
    -1, -1, -1, -1, 0,  1,  2,  3,  12, 13, 14, 15, -1, -1, -1, -1, -1, -1, -1,
    -1, 4,  5,  12, 13, 14, 15, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,
    4,  5,  12, 13, 14, 15, -1, -1, -1, -1, -1, -1, -1, -1, 2,  3,  4,  5,  12,
    13, 14, 15, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  2,  3,  4,  5,  12, 13,
    14, 15, -1, -1, -1, -1, -1, -1, 6,  7,  12, 13, 14, 15, -1, -1, -1, -1, -1,
    -1, -1, -1, -1, -1, 0,  1,  6,  7,  12, 13, 14, 15, -1, -1, -1, -1, -1, -1,
    -1, -1, 2,  3,  6,  7,  12, 13, 14, 15, -1, -1, -1, -1, -1, -1, -1, -1, 0,
    1,  2,  3,  6,  7,  12, 13, 14, 15, -1, -1, -1, -1, -1, -1, 4,  5,  6,  7,
    12, 13, 14, 15, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  4,  5,  6,  7,  12,
    13, 14, 15, -1, -1, -1, -1, -1, -1, 2,  3,  4,  5,  6,  7,  12, 13, 14, 15,
    -1, -1, -1, -1, -1, -1, 0,  1,  2,  3,  4,  5,  6,  7,  12, 13, 14, 15, -1,
    -1, -1, -1, 8,  9,  12, 13, 14, 15, -1, -1, -1, -1, -1, -1, -1, -1, -1, -1,
    0,  1,  8,  9,  12, 13, 14, 15, -1, -1, -1, -1, -1, -1, -1, -1, 2,  3,  8,
    9,  12, 13, 14, 15, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  2,  3,  8,  9,
    12, 13, 14, 15, -1, -1, -1, -1, -1, -1, 4,  5,  8,  9,  12, 13, 14, 15, -1,
    -1, -1, -1, -1, -1, -1, -1, 0,  1,  4,  5,  8,  9,  12, 13, 14, 15, -1, -1,
    -1, -1, -1, -1, 2,  3,  4,  5,  8,  9,  12, 13, 14, 15, -1, -1, -1, -1, -1,
    -1, 0,  1,  2,  3,  4,  5,  8,  9,  12, 13, 14, 15, -1, -1, -1, -1, 6,  7,
    8,  9,  12, 13, 14, 15, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  6,  7,  8,
    9,  12, 13, 14, 15, -1, -1, -1, -1, -1, -1, 2,  3,  6,  7,  8,  9,  12, 13,
    14, 15, -1, -1, -1, -1, -1, -1, 0,  1,  2,  3,  6,  7,  8,  9,  12, 13, 14,
    15, -1, -1, -1, -1, 4,  5,  6,  7,  8,  9,  12, 13, 14, 15, -1, -1, -1, -1,
    -1, -1, 0,  1,  4,  5,  6,  7,  8,  9,  12, 13, 14, 15, -1, -1, -1, -1, 2,
    3,  4,  5,  6,  7,  8,  9,  12, 13, 14, 15, -1, -1, -1, -1, 0,  1,  2,  3,
    4,  5,  6,  7,  8,  9,  12, 13, 14, 15, -1, -1, 10, 11, 12, 13, 14, 15, -1,
    -1, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  10, 11, 12, 13, 14, 15, -1, -1,
    -1, -1, -1, -1, -1, -1, 2,  3,  10, 11, 12, 13, 14, 15, -1, -1, -1, -1, -1,
    -1, -1, -1, 0,  1,  2,  3,  10, 11, 12, 13, 14, 15, -1, -1, -1, -1, -1, -1,
    4,  5,  10, 11, 12, 13, 14, 15, -1, -1, -1, -1, -1, -1, -1, -1, 0,  1,  4,
    5,  10, 11, 12, 13, 14, 15, -1, -1, -1, -1, -1, -1, 2,  3,  4,  5,  10, 11,
    12, 13, 14, 15, -1, -1, -1, -1, -1, -1, 0,  1,  2,  3,  4,  5,  10, 11, 12,
    13, 14, 15, -1, -1, -1, -1, 6,  7,  10, 11, 12, 13, 14, 15, -1, -1, -1, -1,
    -1, -1, -1, -1, 0,  1,  6,  7,  10, 11, 12, 13, 14, 15, -1, -1, -1, -1, -1,
    -1, 2,  3,  6,  7,  10, 11, 12, 13, 14, 15, -1, -1, -1, -1, -1, -1, 0,  1,
    2,  3,  6,  7,  10, 11, 12, 13, 14, 15, -1, -1, -1, -1, 4,  5,  6,  7,  10,
    11, 12, 13, 14, 15, -1, -1, -1, -1, -1, -1, 0,  1,  4,  5,  6,  7,  10, 11,
    12, 13, 14, 15, -1, -1, -1, -1, 2,  3,  4,  5,  6,  7,  10, 11, 12, 13, 14,
    15, -1, -1, -1, -1, 0,  1,  2,  3,  4,  5,  6,  7,  10, 11, 12, 13, 14, 15,
    -1, -1, 8,  9,  10, 11, 12, 13, 14, 15, -1, -1, -1, -1, -1, -1, -1, -1, 0,
    1,  8,  9,  10, 11, 12, 13, 14, 15, -1, -1, -1, -1, -1, -1, 2,  3,  8,  9,
    10, 11, 12, 13, 14, 15, -1, -1, -1, -1, -1, -1, 0,  1,  2,  3,  8,  9,  10,
    11, 12, 13, 14, 15, -1, -1, -1, -1, 4,  5,  8,  9,  10, 11, 12, 13, 14, 15,
    -1, -1, -1, -1, -1, -1, 0,  1,  4,  5,  8,  9,  10, 11, 12, 13, 14, 15, -1,
    -1, -1, -1, 2,  3,  4,  5,  8,  9,  10, 11, 12, 13, 14, 15, -1, -1, -1, -1,
    0,  1,  2,  3,  4,  5,  8,  9,  10, 11, 12, 13, 14, 15, -1, -1, 6,  7,  8,
    9,  10, 11, 12, 13, 14, 15, -1, -1, -1, -1, -1, -1, 0,  1,  6,  7,  8,  9,
    10, 11, 12, 13, 14, 15, -1, -1, -1, -1, 2,  3,  6,  7,  8,  9,  10, 11, 12,
    13, 14, 15, -1, -1, -1, -1, 0,  1,  2,  3,  6,  7,  8,  9,  10, 11, 12, 13,
    14, 15, -1, -1, 4,  5,  6,  7,  8,  9,  10, 11, 12, 13, 14, 15, -1, -1, -1,
    -1, 0,  1,  4,  5,  6,  7,  8,  9,  10, 11, 12, 13, 14, 15, -1, -1, 2,  3,
    4,  5,  6,  7,  8,  9,  10, 11, 12, 13, 14, 15, -1, -1, 0,  1,  2,  3,  4,
    5,  6,  7,  8,  9,  10, 11, 12, 13, 14, 15};

/**
 * From Schlegel et al., Fast Sorted-Set Intersection using SIMD Instructions
 * Optimized by D. Lemire on May 3rd 2013
 */
int32_t intersect_vector16(const uint16_t *A, size_t s_a, const uint16_t *B,
                           size_t s_b, uint16_t *C) {
    size_t count = 0;
    size_t i_a = 0, i_b = 0;

    const size_t st_a = (s_a / 8) * 8;
    const size_t st_b = (s_b / 8) * 8;
    __m128i v_a, v_b;
    if ((i_a < st_a) && (i_b < st_b)) {
        v_a = _mm_lddqu_si128((__m128i *)&A[i_a]);
        v_b = _mm_lddqu_si128((__m128i *)&B[i_b]);
        while ((A[i_a] == 0) || (B[i_b] == 0)) {
            const __m128i res_v = _mm_cmpestrm(
                v_b, 8, v_a, 8,
                _SIDD_UWORD_OPS | _SIDD_CMP_EQUAL_ANY | _SIDD_BIT_MASK);
            const int r = _mm_extract_epi32(res_v, 0);
            __m128i sm16 = _mm_load_si128((const __m128i *)shuffle_mask16 + r);
            __m128i p = _mm_shuffle_epi8(v_a, sm16);
            _mm_storeu_si128((__m128i *)&C[count], p);
            count += _mm_popcnt_u32(r);
            const uint16_t a_max = A[i_a + 7];
            const uint16_t b_max = B[i_b + 7];
            if (a_max <= b_max) {
                i_a += 8;
                if (i_a == st_a) break;
                v_a = _mm_lddqu_si128((__m128i *)&A[i_a]);
            }
            if (b_max <= a_max) {
                i_b += 8;
                if (i_b == st_b) break;
                v_b = _mm_lddqu_si128((__m128i *)&B[i_b]);
            }
        }
        if ((i_a < st_a) && (i_b < st_b))
            while (true) {
                const __m128i res_v = _mm_cmpistrm(
                    v_b, v_a,
                    _SIDD_UWORD_OPS | _SIDD_CMP_EQUAL_ANY | _SIDD_BIT_MASK);
                const int r = _mm_extract_epi32(res_v, 0);
                __m128i sm16 =
                    _mm_load_si128((const __m128i *)shuffle_mask16 + r);
                __m128i p = _mm_shuffle_epi8(v_a, sm16);
                _mm_storeu_si128((__m128i *)&C[count], p);
                count += _mm_popcnt_u32(r);
                const uint16_t a_max = A[i_a + 7];
                const uint16_t b_max = B[i_b + 7];
                if (a_max <= b_max) {
                    i_a += 8;
                    if (i_a == st_a) break;
                    v_a = _mm_lddqu_si128((__m128i *)&A[i_a]);
                }
                if (b_max <= a_max) {
                    i_b += 8;
                    if (i_b == st_b) break;
                    v_b = _mm_lddqu_si128((__m128i *)&B[i_b]);
                }
            }
    }
    // intersect the tail using scalar intersection
    while (i_a < s_a && i_b < s_b) {
        int16_t a = A[i_a];
        int16_t b = B[i_b];
        if (a < b) {
            i_a++;
        } else if (b < a) {
            i_b++;
        } else {
            C[count] = a;  //==b;
            count++;
            i_a++;
            i_b++;
        }
    }

    return count;
}
